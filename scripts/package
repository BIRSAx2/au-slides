#!/bin/sh
set -e

. "$(dirname "$0")/setup"

if [ -z "$1" ] || [ "$1" = "help" ]; then
    echo "Usage: package TARGET (@local or @preview)"
    exit 1
fi

TARGET_BASE=$(resolve_target "$1")
TARGET_DIR="${TARGET_BASE}/${PKG_NAME}/${PKG_VERSION}"

echo "Installing to: $TARGET_DIR"

TMP_DIR=$(mktemp -d)

find . -maxdepth 2 \
    ! -name "." \
    ! -name "scripts" \
    ! -name "thumbnails" \
    ! -name ".git" \
    ! -name "justfile" \
    ! -name "*.pdf" \
    -exec cp -R {} "$TMP_DIR/" \; 2>/dev/null || true

if [ -d "$TARGET_DIR" ]; then
    echo "Overwriting existing version..."
    rm -rf "$TARGET_DIR"
fi

mkdir -p "$TARGET_DIR"
cp -R "$TMP_DIR"/* "$TARGET_DIR/"
rm -rf "$TMP_DIR"

echo "Package $PKG_NAME:$PKG_VERSION installed."
